{% extends "base.html" %}
{% load staticfiles %}
{% load misc %}

{% block extra_head %}
<link href={% static "assets/global/plugins/datatables/datatables.min.css" %} rel="stylesheet" type="text/css" />
<link href={% static "assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css" %} rel="stylesheet" type="text/css" />
{% endblock %}

{% block pagina_titulo_icone %}
<i class="icon-pin font-yellow-crusta"></i>
{% endblock %}

{% block content %}
<div class="portlet-body">
        <table id="posicoes" class="table table-striped table-bordered table-hover table-header-fixed">
        <thead>
            <tr>
                <th>Criptomoeda</th>
                <th>Valor unit√°rio</th>
                <th>Quantidade</th>
                <th>Total atual</th>
            </tr>
        </thead>
        <tbody>
        {% for moeda in moedas %}
            <tr>
                <td>{{moeda.nome}}</td>
                <td id="{{moeda.ticker}}_valor"></td>
                <td id="{{moeda.ticker}}_qtd">{{moeda.qtd_atual|casas_decimais}} {{moeda.ticker}}</td>
                <td id="{{moeda.ticker}}_total"></td>
            </tr>
        {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <th colspan="3">Total</th>
                <th id="total"></th>
            </tr>
        </tfoot>
        </table>
    </div>

{% endblock %}

{% block extra_footer %}
<script src={% static "assets/global/scripts/datatable.min.js" %} type="text/javascript"></script>
<script src={% static "assets/global/plugins/datatables/datatables.min.js" %} type="text/javascript"></script>
<script src={% static "assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.js" %} type="text/javascript"></script>
<script src={% static "assets/pages/scripts/table-datatables-fixedheader.min.js" %} type="text/javascript"></script>
<script src={% static "assets/global/plugins/moment.min.js" %} type="text/javascript"></script>
<script src="https://cdn.datatables.net/plug-ins/1.10.15/sorting/datetime-moment.js" type="text/javascript"></script>
<script type="text/javascript">
$.fn.dataTable.moment( 'DD/MM/YYYY' );

$( document ).ready(function() {
	var tickers = '{% for moeda in moedas %}{{moeda.ticker}}{% if forloop.counter < moedas|length %},{% endif %}{% endfor %}';
	$.ajax({
        url : "https://min-api.cryptocompare.com/data/pricemulti?fsyms=" + tickers + "&tsyms=BRL", // the endpoint
        type : "GET", // http method

        // handle a successful response
        success : function(retorno) {
        	var lista_ticker = tickers.split(',');
        	var valor_total = 0;
            for (var i = 0; i < lista_ticker.length; i++) {
            	var ticker = lista_ticker[i];
                var valor_atual = retorno[ticker].BRL;
                // Alterar valores na tabela
                $('#' + ticker + '_valor').text('R$ ' + valor_atual.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.'));
                var total_ticker = valor_atual * $('#' + ticker + '_qtd').text().split(' ')[0].replace('.', '').replace(',', '.');
                $('#' + ticker + '_total').text('R$ ' + total_ticker.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.'));
                valor_total += total_ticker;
            }
            $('#total').text('R$ ' + valor_total.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.'));
        },

        // handle a non-successful response
        error : function(xhr,errmsg,err) {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
        }
    });
});
</script>
{% endblock %}


    {% extends "base.html" %}

{% block content %}
<div class="row-fluid">
    <div class="span10">
        <h1>{{divisao.nome}}</h1>
    </div>
    <div class="span2">
        <a href="{% url 'editar_divisao' divisao.id %}" class="btn btn-small btn-warning">Editar divisão</a>
    </div>
</div>
<div class="row-fluid">
    <div class="box-content">
    <h3>Composição (selecione para detalhar)</h3>
    <table class="table table-striped table-bordered bootstrap-datatable datatable">
    <thead>
        <tr>
            <th>Tipo de investimento</th>
            <th>Valor total</th>
        </tr>
    </thead>
    <tbody>
    {% for key, item in composicao.items %}
    <tr>
        <td><a href="#" onclick="mostrarComposicao('{{ key }}');">{{item.nome}}</a></td>
        <td>R${{item.patrimonio|floatformat:"2"}} ({{item.percentual|floatformat:"2"}}%)</td>
    </tr>
    {% endfor %}
    <tfoot>
        <tr>
            <th>Total</th>
            <th>R${{divisao.valor_total|floatformat:"2"}}</th>
        </tr>
    </tfoot>
    </tbody>
    </table>
    </div>
</div>
    
<div class="row-fluid">
    <div id="composicao_item" class="hidden box-content">
    <h3>Investimentos (selecione para detalhar)</h3>
    <table id="tab_composicao" class="table table-striped table-bordered bootstrap-datatable datatable">
    <thead>
        <tr>
            <th>Nome</th>
            <th>Valor</th>
        </tr>
    </thead>
    <tbody>
    {% for key, item in composicao.items %}
        {% for key_composicao, item_composicao in item.composicao.items %}
    <tr name="{{key}}">
        <td><a href="#" onclick="mostrarOperacoes('{{key}}_{{ key_composicao }}');">{{item_composicao.nome}}</a></td>
        <td>R${{item_composicao.patrimonio|floatformat:"2"}} ({{item_composicao.percentual|floatformat:"2"}}%)</td>
    </tr>
        {% endfor %}
    {% endfor %}
    <tfoot>
        <tr>
            <th>Total</th>
            <th id="item_total">R$0</th>
        </tr>
    </tfoot>
    </tbody>
    </table>
    </div>
</div>

<div class="row-fluid">
    <div id="composicao_operacao" class="hidden box-content">
    <h3>Operações</h3>
    <table id="tab_operacao" class="table table-striped table-bordered bootstrap-datatable datatable mostrar-operacoes">
    <thead>
        <tr>
            <th>Tipo</th>
            <th>Quantidade</th>
            <th>Data</th>
            <th>Valor unit.</th>
            <th>Valor total</th>
        </tr>
    </thead>
    <tbody>
    {% for key, item in composicao.items %}
        {% for key_composicao, item_composicao in item.composicao.items %}
            {% for key_operacao, item_operacao in item_composicao.composicao.items %}
    <tr class="operacao-{{key}}_{{key_composicao}}">
        <td>{{item_operacao.nome}}</a></td>
        <td>{{item_operacao.quantidade}}</a></td>
        <td>{{item_operacao.data|date:"Y-m-d"}}</a></td>
        <td>{{item_operacao.valor_unitario}}</a></td>
        <td>R${{item_operacao.patrimonio|floatformat:"2"}}</td>
    </tr>
            {% endfor %}
        {% endfor %}
    {% endfor %}
    <tfoot>
        <tr>
            <th colspan="4">Total</th>
            <th id="operacao_total">R$0</th>
        </tr>
    </tfoot>
    </tbody>
    </table>
    </div>
</div>

<script>
//Mostrar composição do tipo de investimento
function mostrarComposicao(key) {
	// Esconder proxima tabela de detalhamento
	$('#composicao_operacao').addClass('hidden');
	// Alterar classe escolhida
    $('#tab_composicao').toggleClass('mostrar-' + key);
	// Mostrar ou esconder tabela atual
	if ($('#tab_composicao').is('.mostrar-acoes, .mostrar-fii, .mostrar-lc, .mostrar-td, .mostrar-cdb-rdb, .mostrar-fundo-investimento')) {
	    $('#composicao_item').removeClass('hidden');
    } else {
    	$('#composicao_item').addClass('hidden');
    }
    var table = $('#tab_composicao').dataTable({"bRetrieve": true});
    table.fnDraw();
    var data = table._('tr', {"filter":"applied"});
    // Preparar total
    var total_composicao = 0;
	$(data).each( function ( index, row ) {
    	total_composicao += parseFloat(row[1].match(/R\$[\d\.,]*/)[0].replace("R$", "").replace(".", "").replace(",", "."));
    	total_composicao = Math.round(total_composicao * 100) / 100;
    });
    $('#item_total').html('R$' + total_composicao.toFixed(2).replace(".", ",").replace(/\B(?=(\d{3})+(?!\d))/g, "."));
}

//Mostrar operações do investimento escolhido
function mostrarOperacoes(key) {
    // Alterar classe escolhida
    $('#tab_operacao').toggleClass('operacao-' + key);
	// Mostrar ou esconder tabela atual
    $('#composicao_operacao').removeClass('hidden');
//     $('#composicao_operacao > div > table > tbody > tr[name!=operacao_' + key + ']').addClass('hidden');
//     $('#composicao_operacao > div > table > tbody > tr[name=operacao_' + key + ']').removeClass('hidden');
    var table = $('#tab_operacao').dataTable({"bRetrieve": true});
    table.fnDraw();
    var data = table._('tr', {"filter":"applied"});
    // Preparar total
    var total_operacao = 0;
    $(data).each( function ( index, row ) {
    	if (row[0] == 'C') {
    	    total_operacao += parseFloat(row[4].match(/R\$[\d\.,]*/)[0].replace("R$", "").replace(".", "").replace(",", "."));
    	} else {
            total_operacao -= parseFloat(row[4].match(/R\$[\d\.,]*/)[0].replace("R$", "").replace(".", "").replace(",", "."));
    	}
    	total_operacao = Math.round(total_operacao * 100) / 100;
    });
    $('#operacao_total').html('R$' + total_operacao.toFixed(2).replace(".", ",").replace(/\B(?=(\d{3})+(?!\d))/g, "."));
}

$.fn.dataTableExt.afnFiltering.push(function (oSettings, aData, iDataIndex) {
    if ($(oSettings.nTable).is('.mostrar-acoes, .mostrar-fii, .mostrar-lc, .mostrar-td, .mostrar-cdb-rdb, .mostrar-fundo-investimento')) {
    	var mostrar = (aData[0].match(/acoes\_/) != null && $(oSettings.nTable).hasClass('mostrar-acoes')) || (aData[0].match(/fii\_/) != null && $(oSettings.nTable).hasClass('mostrar-fii')) ||
    	   (aData[0].match(/lc\_/) != null && $(oSettings.nTable).hasClass('mostrar-lc')) || (aData[0].match(/td\_/) != null && $(oSettings.nTable).hasClass('mostrar-td')) ||
    	   (aData[0].match(/cdb-rdb\_/) != null && $(oSettings.nTable).hasClass('mostrar-cdb-rdb')) || (aData[0].match(/td\_/) != null && $(oSettings.nTable).hasClass('mostrar-fundo-investimento'));
        return mostrar;
    } else return true;
});

$.fn.dataTableExt.afnFiltering.push(function (oSettings, aData, iDataIndex) {
    if ($(oSettings.nTable).hasClass('mostrar-operacoes')) {
    	var classe_linha = oSettings.aoData[iDataIndex].nTr.className.split(" ");
    	var mostrar = ($(oSettings.nTable).hasClass(classe_linha[0]));
        return mostrar;
    } else return true;
});
</script>
{% endblock %}
